"use strict";const h=require("./components.js"),d=require("vue");function T(t){P(t)(d.unref(t.currentRoute).fullPath,!0)}const p=t=>{const{params:s,path:e,query:i}=t;return{params:s||{},path:e,query:i||{}}},E=h.setting.multiTabsSetting.cache,m=h.defineStore({id:"app-multiple-tab",state:()=>({cacheTabList:new Set,tabList:E?h.Persistent.getLocal(h.MULTIPLE_TABS_KEY)||[]:[],lastDragEndIndex:0}),getters:{getTabList(t){return t.tabList},getCachedTabList(t){return Array.from(t.cacheTabList)},getLastDragEndIndex(t){return t.lastDragEndIndex}},actions:{async updateCacheTab(){var s;const t=new Set;for(const e of this.tabList){const i=h.getRawRoute(e);if(!!((s=i.meta)!=null&&s.ignoreKeepAlive))continue;const c=i.name;t.add(c)}this.cacheTabList=t},async refreshPage(t){const{currentRoute:s}=t,i=d.unref(s).name,n=this.getCachedTabList.find(a=>a===i);n&&this.cacheTabList.delete(n),await x(t)()},clearCacheTabs(){this.cacheTabList=new Set},resetState(){this.tabList=[],this.clearCacheTabs()},goToPage(t){const s=P(t),e=this.tabList.length,{path:i}=d.unref(t.currentRoute);let n=h.PageEnum.BASE_HOME;if(e>0){const c=this.tabList[e-1],a=c.fullPath||c.path;a&&(n=a)}i!==n&&s(n,!0)},async addTab(t){const{path:s,name:e,fullPath:i,params:n,query:c,meta:a}=h.getRawRoute(t);if(s===h.PageEnum.ERROR_PAGE||s===h.PageEnum.BASE_LOGIN||!e||[h.REDIRECT_ROUTE.name,h.PAGE_NOT_FOUND_ROUTE.name].includes(e))return;let o=-1;if(this.tabList.some((l,f)=>(o=f,decodeURIComponent(l.fullPath||l.path)===decodeURIComponent(i||s)))){const l=d.toRaw(this.tabList)[o];if(!l)return;l.params=n||l.params,l.query=c||l.query,l.fullPath=i||l.fullPath,this.tabList.splice(o,1,l)}else{const l=(a==null?void 0:a.dynamicLevel)??-1;if(l>0){const f=(a==null?void 0:a.realPath)??"";if(this.tabList.filter(b=>{var u;return((u=b.meta)==null?void 0:u.realPath)??f===""}).length>=l){const b=this.tabList.findIndex(u=>u.meta.realPath===f);b!==-1&&this.tabList.splice(b,1)}}this.tabList.push(t)}this.updateCacheTab(),E&&h.Persistent.setLocal(h.MULTIPLE_TABS_KEY,this.tabList)},async closeTab(t,s){const e=r=>{const{fullPath:l,meta:{affix:f}={}}=r;if(f)return;const b=this.tabList.findIndex(u=>u.fullPath===l);b!==-1&&this.tabList.splice(b,1)},{currentRoute:i,replace:n}=s,{path:c}=d.unref(i);if(c!==t.path){e(t),this.updateCacheTab();return}let a={};const o=this.tabList.findIndex(r=>r.path===c);if(o===0)if(this.tabList.length===1)a=h.useUserStore().getUserInfo.homePath||h.PageEnum.BASE_HOME;else{const r=this.tabList[o+1];a=p(r)}else{const r=this.tabList[o-1];a=p(r)}e(i.value),await n(a)},async closeTabByKey(t,s){const e=this.tabList.findIndex(i=>(i.fullPath||i.path)===t);if(e!==-1){await this.closeTab(this.tabList[e],s);const{currentRoute:i,replace:n}=s;if(this.tabList.findIndex(a=>a.fullPath===i.value.fullPath)===-1){let a;if(e>0?a=e-1:e<this.tabList.length-1?a=e+1:a=-1,a>=0){const o=this.tabList[e-1],r=p(o);await n(r)}}}},async sortTabs(t,s){const e=this.tabList[t];this.tabList.splice(t,1),this.tabList.splice(s,0,e),this.lastDragEndIndex=this.lastDragEndIndex+1},async closeLeftTabs(t,s){var i;const e=this.tabList.findIndex(n=>n.path===t.path);if(e>0){const n=this.tabList.slice(0,e),c=[];for(const a of n)(((i=a==null?void 0:a.meta)==null?void 0:i.affix)??!1)||c.push(a.fullPath);this.bulkCloseTabs(c)}this.updateCacheTab(),T(s)},async closeRightTabs(t,s){var i;const e=this.tabList.findIndex(n=>n.fullPath===t.fullPath);if(e>=0&&e<this.tabList.length-1){const n=this.tabList.slice(e+1,this.tabList.length),c=[];for(const a of n)(((i=a==null?void 0:a.meta)==null?void 0:i.affix)??!1)||c.push(a.fullPath);this.bulkCloseTabs(c)}this.updateCacheTab(),T(s)},async closeAllTab(t){this.tabList=this.tabList.filter(s=>{var e;return((e=s==null?void 0:s.meta)==null?void 0:e.affix)??!1}),this.clearCacheTabs(),this.goToPage(t)},async closeOtherTabs(t,s){var n;const e=this.tabList.map(c=>c.fullPath),i=[];for(const c of e)if(c!==t.fullPath){const a=this.tabList.find(r=>r.fullPath===c);if(!a)continue;(((n=a==null?void 0:a.meta)==null?void 0:n.affix)??!1)||i.push(a.fullPath)}this.bulkCloseTabs(i),this.updateCacheTab(),h.Persistent.setLocal(h.MULTIPLE_TABS_KEY,this.tabList,!0),T(s)},async bulkCloseTabs(t){this.tabList=this.tabList.filter(s=>!t.includes(s.fullPath))},async setTabTitle(t,s){const e=this.getTabList.find(i=>i===s);e&&(e.meta.title=t,await this.updateCacheTab())},async updateTabPath(t,s){const e=this.getTabList.find(i=>i===s);e&&(e.fullPath=t,e.path=t,await this.updateCacheTab())}}});function g(t){console.error(t)}function P(t){const{push:s,replace:e,currentRoute:i}=t||h.useRouter();function n(c=h.PageEnum.BASE_HOME,a=!1){if(!c)return;let o=d.unref(c);if(o[0]==="/"&&(o=o.slice(1)),h.isHttpUrl(o))return h.openWindow(o);const r=a===!0||a===0,l=a===1;if(r)e(c).catch(g);else if(l){const f=m(),b=d.unref(i).name,u=f.getTabList.findIndex(L=>L.name===b),R=f.getTabList.length;s(c).then(()=>{if(f.getTabList.length>R){const L=f.getTabList.length-1;u>-1&&L>u&&f.sortTabs(L,u+1)}}).catch(g)}else s(c).catch(g)}return n}const x=t=>{const{replace:s,currentRoute:e}=t||h.useRouter(),{query:i,params:n={},name:c,fullPath:a}=d.unref(e.value);function o(){return new Promise(r=>{if(c===h.REDIRECT_NAME){r(!1);return}c&&Object.keys(n).length>0?(n._origin_params=JSON.stringify(n??{}),n._redirect_type="name",n.path=String(c)):(n._redirect_type="path",n.path=a),s({name:h.REDIRECT_NAME,params:n,query:i}).then(()=>r(!0))})}return o};exports.useGo=P;exports.useMultipleTabStore=m;exports.useRedo=x;
